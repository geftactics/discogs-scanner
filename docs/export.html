<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Discogs Exporter</title>
</head>
<body>
  <h1>Discogs Collection Exporter</h1>
  <label>Personal Access Token: <input type="text" id="token" /></label>
  <button onclick="start()">Export to CSV</button>

  <script>
    async function start() {
      const token = document.getElementById('token').value.trim();
      if (!token) {
        alert("Please enter your Discogs token");
        return;
      }

      try {
        console.log("üîê Fetching user info...");
        const userRes = await fetch('https://api.discogs.com/oauth/identity', {
          headers: { 'Authorization': `Discogs token=${token}` }
        });

        if (!userRes.ok) throw new Error('Failed to fetch user info');
        const user = await userRes.json();
        console.log("üë§ Username:", user.username);

        let items = [];
        let page = 1;
        let pages = 1;

        console.log("üì¶ Fetching collection...");
        do {
          const url = `https://api.discogs.com/users/${user.username}/collection/folders/0/releases?page=${page}&per_page=100`;
          console.log(`üìÑ Fetching page ${page} of ${pages}`);
          const res = await fetch(url, {
            headers: { 'Authorization': `Discogs token=${token}` }
          });

          if (!res.ok) throw new Error(`Failed to fetch collection page ${page}`);
          const json = await res.json();

          pages = json.pagination.pages;
          items = items.concat(json.releases);
          page++;

        } while (page <= pages);

        console.log(`‚úÖ Retrieved ${items.length} items`);

        // CSV headers
        const rows = [['release_id', 'instance_id', 'artist', 'catalog_number', 'label']];

        items.forEach((item, idx) => {
          if (!item || !item.release) {
            console.warn(`‚ö†Ô∏è Skipping item ${idx} - missing release`, item);
            return;
          }

          const releaseId = item.release.id || '';
          const instanceId = item.instance_id || '';
          const artists = item.basic_information?.artists?.map(a => a.name).join(' / ') || '';
          const catno = item.basic_information?.labels?.map(l => l.catno).join(' / ') || '';
          const labels = item.basic_information?.labels?.map(l => l.name).join(' / ') || '';

          console.log(`üìÄ Item ${idx + 1}: ${artists} [${catno}] on ${labels}`);

          rows.push([releaseId, instanceId, artists, catno, labels]);
        });

        // Convert to CSV
        const csv = rows.map(r => r.map(field => `"${field.replace(/"/g, '""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `discogs-collection-${user.username}.csv`;
        link.click();

        console.log("‚úÖ CSV downloaded!");

      } catch (e) {
        console.error("‚ùå Error:", e);
        alert(`Error: ${e.message}`);
      }
    }
  </script>
</body>
</html>
